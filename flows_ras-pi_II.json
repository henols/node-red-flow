[{"id":"792fa8ec.b28a38","type":"tab","label":"Emon poster"},{"id":"8f2bcdc5.cc23e","type":"tab","label":"Remote Switch","disabled":false,"info":""},{"id":"ea0c1405.b63778","type":"tab","label":"Traffic counter"},{"id":"a941cad7.5549a8","type":"tab","label":"Verisure SmartPlug contole","disabled":false,"info":""},{"id":"e2391743.cbd018","type":"tab","label":"Flow 2","disabled":false,"info":""},{"id":"2e500814.3e3ca8","type":"tab","label":"Flow 3","disabled":false,"info":""},{"id":"c11d79a4.e9bc68","type":"twitter-credentials","z":"","screen_name":"@aceone_"},{"id":"63e8ee4a.883ac","type":"mqtt-broker","z":"","broker":"localhost","port":"6883","clientid":"","usetls":false,"compatmode":true,"keepalive":"15","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"2c64fd6d.ec5432","type":"mqtt-broker","z":"","broker":"192.168.1.170","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"15","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"fee7a4df.4347c8","type":"mqtt-broker","z":"","name":"RasPi I","broker":"192.168.1.121","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"b4c7cf30.4f907","type":"twitter-credentials","z":"","screen_name":"@Mulbetet49"},{"id":"83e8c7cb.466b48","type":"serial-port","z":"","serialport":"","serialbaud":"57600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false,"responsetimeout":"10000"},{"id":"31ccddc3.399cc2","type":"emoncms-server","z":"","server":"http://192.168.1.215/emon","name":"Emon"},{"id":"e860117e.3ef7","type":"VerisureConfig","z":"","displayName":"Verisure Site","siteName":"Home"},{"id":"1e182e78.ed4e32","type":"xiaomi-configurator","z":"","name":"Gateway","ip":"192.168.1.228","sid":"3588f788bb6fa7e3713555876484149f","deviceList":[{"sid":"","desc":"my plug","model":"plug"},{"sid":"","desc":"","model":"sensor_ht"}],"key":"sa2m9g2tcnxynonn"},{"id":"ab4639e2.fd1e08","type":"pushbullet-config","z":"","name":"mail.com"},{"id":"75c355c6.2b40bc","type":"xiaomi-gateway-config","z":"","name":"MI Gateway","deviceList":[{"sid":"","desc":"","model":"switch"}],"address":"224.0.0.50","port":"9898","key":""},{"id":"93b41423.ea0f18","type":"xiaomi-configurator","z":"","name":"","deviceList":[{"sid":"","desc":"","model":"switch"}],"key":""},{"id":"f6b45139.5e414","type":"mqtt in","z":"792fa8ec.b28a38","name":"Temperature","topic":"+/temperature/#","qos":"2","broker":"fee7a4df.4347c8","x":110,"y":160,"wires":[["f18879ef.e0aa58","21be3f51.c23c2","e6616246.577b5","d3a955.ef8e86a8","8bae1c6d.93eee"]]},{"id":"881055a1.2b5b88","type":"mqtt in","z":"792fa8ec.b28a38","name":"Energy Consumption","topic":"+/powermeter/#","qos":"2","broker":"fee7a4df.4347c8","x":140,"y":100,"wires":[["aa3e098f.c76a88"]]},{"id":"f18879ef.e0aa58","type":"function","z":"792fa8ec.b28a38","name":"Build Topic for Emon","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\n\nif(msg.topic.indexOf('temperature')>0){\n\tmsg.nodegroup = 17;\n}else{\n\tmsg.nodegroup = 5;\n}\nplace = msg.topic.substring(0,msg.topic.indexOf('/'));\ntype = msg.topic.substring(msg.topic.lastIndexOf('/')+1);\nmsg.payload = type+\"_\"+place + \":\"+msg.payload;\nreturn msg;","outputs":"1","noerr":0,"x":500,"y":180,"wires":[["d2d583fb.d57c1","c332982c.30c208"]]},{"id":"bcd0f77d.8ce958","type":"twitter out","z":"792fa8ec.b28a38","twitter":"b4c7cf30.4f907","name":"Huset","x":970,"y":340,"wires":[]},{"id":"21be3f51.c23c2","type":"function","z":"792fa8ec.b28a38","name":"Temperature messages","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\nif(msg.topic.indexOf('1053C65B02080047') >= 0){\n\tcontext.place = msg.topic.substring(0,msg.topic.indexOf('/'))\n\tvar temp = parseFloat(msg.payload);\n\tcontext.lastTemp = temp;\n\t\n\t if(typeof context.minTemp === 'undefined' || temp < context.minTemp){\n\t\tcontext.minTemp = temp;\n\t\tcontext.minStamp = Date.now();\n\t}\n\tif(typeof context.maxTemp === 'undefined' || temp > context.maxTemp){\n\t\tcontext.maxTemp = temp;\n\t\tcontext.maxStamp = Date.now();\n\t}\n\t\n\tcontext.time = formatTime(context.maxStamp);\n\t\n\tif(typeof context.totalTemp === 'undefined'){\n\t\tcontext.totalTemp = 0;\n\t}\n\tif(typeof context.numberOfTempVals === 'undefined'){\n\t\tcontext.numberOfTempVals = 0;\n\t}\n\t\n\tcontext.totalTemp += temp;\n\tcontext.numberOfTempVals++;\n\t\n} else \n if(msg.topic == 'tweet_temp'){\n\tif(msg.payload == 'now'){\n\t\t// The temperature are 2.81°C at 12:00. #temperature #smarthome\n\t\tmsg.payload = context.place + ' The temperature are '+ context.lastTemp + '°C at ' + formatTime(Date.now()) +'. #temperature #smarthome';\n\t\treturn msg;\n\t\n\t} else if(msg.payload == 'summary'){\n\t\tvar average = (Math.round((context.totalTemp / context.numberOfTempVals) * 100 ) / 100);\n\t\t //Last day's temperatures: average:2.23°C, max:3.0°C at 13:04, min:1.63°C at 07:29. #temperature #smarthome\n\t\tmsg.payload = context.place + ' Last day\\'s temperatures: average:'+ average + '°C, max:' + context.maxTemp +'°C at ' + formatTime(context.maxStamp) +\n\t\t', min:' + context.minTemp+'°C at ' + formatTime(context.minStamp) +'. #temperature #smarthome';\n\t\tcontext.totalTemp = 0;\n\t\tcontext.numberOfTempVals = 0;\n\t\tcontext.minTemp = 100;\n\t\tcontext.maxTemp = -100;\n\t\treturn msg;\n\t}\n}\nfunction formatTime(millis){\n\tvar d = new Date(millis);\n\treturn (\"00\" + d.getHours()).slice(-2) + \":\" +   (\"00\" + d.getMinutes()).slice(-2);\n}\n\n","outputs":1,"noerr":0,"x":510,"y":280,"wires":[["dec1351.f374cc8","bcd0f77d.8ce958","b45b4e29.ffdb1"]]},{"id":"dec1351.f374cc8","type":"debug","z":"792fa8ec.b28a38","name":"","active":false,"complete":"true","x":970,"y":460,"wires":[]},{"id":"3708e398.76681c","type":"inject","z":"792fa8ec.b28a38","name":"Tweet temp@00.00","topic":"tweet_temp","payload":"now","repeat":"","crontab":"00 00 * * *","once":false,"x":140,"y":300,"wires":[["21be3f51.c23c2"]]},{"id":"5bd3f56a.8664bc","type":"inject","z":"792fa8ec.b28a38","name":"Tweet summary@08:00","topic":"tweet_temp","payload":"summary","repeat":"","crontab":"00 08 * * *","once":false,"x":150,"y":460,"wires":[["21be3f51.c23c2"]]},{"id":"8739fcbe.37417","type":"inject","z":"792fa8ec.b28a38","name":"Tweet temp@06.00","topic":"tweet_temp","payload":"now","repeat":"","crontab":"00 06 * * *","once":false,"x":140,"y":340,"wires":[["21be3f51.c23c2"]]},{"id":"8347c7ae.2fbe08","type":"inject","z":"792fa8ec.b28a38","name":"Tweet temp@18.00","topic":"tweet_temp","payload":"now","repeat":"","crontab":"00 18 * * *","once":false,"x":140,"y":420,"wires":[["21be3f51.c23c2"]]},{"id":"bad48680.4cebc8","type":"inject","z":"792fa8ec.b28a38","name":"Tweet temp@12.00","topic":"tweet_temp","payload":"now","repeat":"","crontab":"00 12 * * *","once":false,"x":140,"y":380,"wires":[["21be3f51.c23c2"]]},{"id":"d34c7f30.33583","type":"mqtt in","z":"792fa8ec.b28a38","name":"Daily Energy Consumption","topic":"+/powermeter/kwh/dailyconsumption0","qos":"2","broker":"fee7a4df.4347c8","x":150,"y":520,"wires":[["17ece604.02625a"]]},{"id":"17ece604.02625a","type":"function","z":"792fa8ec.b28a38","name":"Daily Energy Consumption","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\nplace = msg.topic.substring(0,msg.topic.indexOf('/'))\nkWh = parseInt(msg.payload) / 10000\nmsg.payload = place + ' Last day\\'s power consumption for the house were '+ kWh +'kWh. #tweetawatt #smarthome';\nreturn msg;\n\n","outputs":1,"noerr":0,"x":520,"y":440,"wires":[["dec1351.f374cc8","bcd0f77d.8ce958","df80a9a1.95a3b8"]]},{"id":"e6616246.577b5","type":"debug","z":"792fa8ec.b28a38","name":"","active":false,"complete":"false","x":470,"y":80,"wires":[]},{"id":"d2d583fb.d57c1","type":"debug","z":"792fa8ec.b28a38","name":"","active":false,"complete":"true","x":750,"y":120,"wires":[]},{"id":"4c9cefbd.40e0d","type":"mqtt in","z":"ea0c1405.b63778","name":"Traffic counter","topic":"traffic/counter/car/#","qos":"2","broker":"fee7a4df.4347c8","x":130,"y":160,"wires":[["f03ff4f1.b81b98","b66700a7.74bfd"]]},{"id":"f03ff4f1.b81b98","type":"function","z":"ea0c1405.b63778","name":"Build Topic for Emon","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\n\nplace = msg.topic.substring(0,msg.topic.indexOf('/'));\ntype = msg.topic.substring(msg.topic.lastIndexOf('/')+1);\nind = msg.payload.lastIndexOf(':');\nmsg.time = Number(msg.payload.substring(ind+1)) / 1000;\nmsg.payload = type+\"_\"+place + \":\"+msg.payload.substring(0,ind);\nreturn msg;","outputs":"1","x":360,"y":160,"wires":[["b66700a7.74bfd"]]},{"id":"b66700a7.74bfd","type":"debug","z":"ea0c1405.b63778","name":"","active":false,"complete":"false","x":590,"y":220,"wires":[]},{"id":"839f3d86.52eff","type":"mqtt in","z":"ea0c1405.b63778","name":"Start","topic":"traffic/counter/start","qos":"2","broker":"fee7a4df.4347c8","x":110,"y":220,"wires":[["64f80ce2.def454","38fa0e07.c1af52"]]},{"id":"3a2d6127.66202e","type":"mqtt in","z":"ea0c1405.b63778","name":"Stop","topic":"traffic/counter/stop","qos":"2","broker":"fee7a4df.4347c8","x":110,"y":280,"wires":[["64f80ce2.def454","38fa0e07.c1af52"]]},{"id":"64f80ce2.def454","type":"debug","z":"ea0c1405.b63778","name":"","active":false,"complete":"true","x":570,"y":280,"wires":[]},{"id":"38fa0e07.c1af52","type":"function","z":"ea0c1405.b63778","name":"Start/Stop Topic for Emon","func":"\n\ntype = msg.topic.substring(msg.topic.lastIndexOf('/')+1);\n\nval = (type == \"start\")?1:0;\nvar newMsg = {payload: msg.payload+\":\"+ (1-val)};\nmsg.payload = msg.payload + \":\"+val;\n\nreturn [[newMsg, msg]];\n//return msg;\n","outputs":"1","noerr":0,"x":370,"y":220,"wires":[["64f80ce2.def454"]]},{"id":"d3a955.ef8e86a8","type":"function","z":"792fa8ec.b28a38","name":"Tweet Sauna is warm","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\nif(msg.topic.indexOf('28FF3E4C310400D2') >= 0){\n\tcontext.place = msg.topic.substring(0,msg.topic.indexOf('/'))\n\tvar temp = parseFloat(msg.payload);\n\tif(temp >= 75 \n\t\t&& (typeof context.saunaTimestamp === 'undefined'\n\t\t|| context.saunaTimestamp < Date.now())) {\n\t\t\n\t\tmsg.payload = context.place + ' @aceone_ The sauna temperature is '\n\t\t\t+ temp + '°C at ' + formatTime(Date.now()) +'. #temperature #smarthome';\n\t\t\tcontext.saunaTimestamp = Date.now() + 3600000;\n\t\t\t\n\t\treturn msg;\n\t}\n\t\n\t\n}\n\nfunction formatTime(millis){\n\tvar d = new Date(millis);\n\treturn (\"00\" + d.getHours()).slice(-2) + \":\" +   (\"00\" + d.getMinutes()).slice(-2);\n}\n\n","outputs":"1","noerr":0,"x":500,"y":480,"wires":[["bcd0f77d.8ce958","dec1351.f374cc8","b45b4e29.ffdb1"]]},{"id":"8bae1c6d.93eee","type":"function","z":"792fa8ec.b28a38","name":"The house is to warm","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\nif(msg.topic.indexOf('1064BC5B020800FF') >= 0 || \n\tmsg.topic.indexOf('10EFD25B0208005E') >= 0){\n\tcontext.place = msg.topic.substring(0,msg.topic.indexOf('/'))\n\tvar temp = parseFloat(msg.payload);\n\tif(temp >= 45) {\n\t\tmsg.payload = context.place + ' @aceone_ WARNING the temperature in the house is '\n\t\t\t+ temp + '°C at ' + formatTime(Date.now()) +'. #temperature #smarthome';\n\t\treturn msg;\n\t}\n\t\n\t\n}\n\nfunction formatTime(millis){\n\tvar d = new Date(millis);\n\treturn (\"00\" + d.getHours()).slice(-2) + \":\" +   (\"00\" + d.getMinutes()).slice(-2);\n}\n\n","outputs":"1","x":500,"y":520,"wires":[["bcd0f77d.8ce958","b45b4e29.ffdb1"]]},{"id":"aa3e098f.c76a88","type":"function","z":"792fa8ec.b28a38","name":"Build Topic for Emon","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\n\nif(msg.topic.indexOf('temperature')>0){\n\tmsg.nodegroup = 17;\n}else{\n\tmsg.nodegroup = 5;\n}\nplace = msg.topic.substring(0,msg.topic.indexOf('/'));\ntype = msg.topic.substring(msg.topic.lastIndexOf('/')+1);\nmsg.payload = type+\"_\"+place + \":\"+msg.payload;\nreturn msg;","outputs":"1","noerr":0,"x":500,"y":140,"wires":[["d2d583fb.d57c1","f9e7836d.40c38"]]},{"id":"149b8b97.811f84","type":"e-mail in","z":"a941cad7.5549a8","name":"","protocol":"IMAP","server":"imap.gmail.com","useSSL":true,"port":"993","box":"INBOX","disposition":"Read","repeat":"30","x":1290,"y":80,"wires":[["461bb9bf.ef7c98"]]},{"id":"461bb9bf.ef7c98","type":"debug","z":"a941cad7.5549a8","name":"","active":true,"console":"false","complete":"true","x":1450,"y":80,"wires":[]},{"id":"5efc355e.05171c","type":"inject","z":"8f2bcdc5.cc23e","name":"Switch off","topic":"smartplug/9987695/output","payload":"0","payloadType":"num","repeat":"","crontab":"00 23 * * *","once":false,"onceDelay":"","x":190,"y":120,"wires":[["f24d3923.e625d8"]]},{"id":"f24d3923.e625d8","type":"mqtt out","z":"8f2bcdc5.cc23e","name":"SmartPlug 9987695","topic":"smartplug/9987695/output","qos":"1","retain":"","broker":"fee7a4df.4347c8","x":440,"y":120,"wires":[]},{"id":"e8451caf.1d13e","type":"inject","z":"8f2bcdc5.cc23e","name":"Switch on","topic":"smartplug/9987695/output","payload":"1","payloadType":"num","repeat":"","crontab":"00 17 * * *","once":false,"onceDelay":"","x":190,"y":160,"wires":[["f24d3923.e625d8"]]},{"id":"4b681ea1.90161","type":"mqtt in","z":"8f2bcdc5.cc23e","name":"Any SmartPlug ","topic":"smartplug/+/output","qos":"1","broker":"fee7a4df.4347c8","x":180,"y":240,"wires":[["a5014c38.405ff"]]},{"id":"a5014c38.405ff","type":"debug","z":"8f2bcdc5.cc23e","name":"","active":false,"console":"false","complete":"true","x":410,"y":240,"wires":[]},{"id":"f31179ea.be4a28","type":"mqtt in","z":"792fa8ec.b28a38","name":"Power Main","topic":"mulbetet49/powermeter/power0","qos":"2","broker":"fee7a4df.4347c8","x":110,"y":600,"wires":[["eb46fb24.82e358"]]},{"id":"4a0675f0.8f4acc","type":"mqtt in","z":"792fa8ec.b28a38","name":"Power Heater","topic":"mulbetet49/powermeter/power1","qos":"2","broker":"fee7a4df.4347c8","x":110,"y":660,"wires":[["eb46fb24.82e358"]]},{"id":"eb46fb24.82e358","type":"function","z":"792fa8ec.b28a38","name":"Calculate house power","func":"if(msg.topic == 'mulbetet49/powermeter/power0'){\n\tvar temp = parseInt(msg.payload);\n\tcontext.housePower = temp;\n\t\n} else if(msg.topic == 'mulbetet49/powermeter/power1'){\n    var temp = parseInt(msg.payload) / 10;\n    var powerHouse = null;\n\tif(typeof context.housePower !== 'undefined'){\n        powerHouse = { payload: (context.housePower - temp) };\n\t}\n\n    var powerHeater = { payload: temp };\n    return [powerHouse, powerHeater];\n\n}\n\n  //  return {msg, newMsg};\n\nreturn null;\n","outputs":"2","noerr":0,"x":500,"y":620,"wires":[["2b747e97.a2e632"],["9af1f531.0b3c18"]]},{"id":"2b747e97.a2e632","type":"mqtt out","z":"792fa8ec.b28a38","name":"Power House","topic":"mulbetet49/powermeter/power2","qos":"2","retain":"false","broker":"fee7a4df.4347c8","x":780,"y":600,"wires":[]},{"id":"9af1f531.0b3c18","type":"mqtt out","z":"792fa8ec.b28a38","name":"Power Heater","topic":"mulbetet49/powermeter/power3","qos":"2","retain":"false","broker":"fee7a4df.4347c8","x":780,"y":660,"wires":[]},{"id":"1850e40.654dd1c","type":"mqtt in","z":"792fa8ec.b28a38","name":"ESP Lua Temperature","topic":"temperature/#","qos":"2","broker":"fee7a4df.4347c8","x":140,"y":220,"wires":[["fe534db0.03226","ea852383.5569c"]]},{"id":"fe534db0.03226","type":"function","z":"792fa8ec.b28a38","name":"Build Topic for Emon","func":"// The received message is stored in 'msg'\n// It will have at least a 'payload' property:\n//   console.log(msg.payload);\n// The 'context' object is available to store state\n// between invocations of the function\n//   context = {};\n\n\nif(msg.topic.indexOf('temperature')>0){\n\tmsg.nodegroup = 17;\n}else{\n\tmsg.nodegroup = 5;\n}\nplace = \"esp-lua\";\ntype = msg.topic.substring(msg.topic.lastIndexOf('/')+1);\nmsg.payload = type+\"_\"+place + \":\"+msg.payload;\nreturn msg;","outputs":"1","noerr":0,"x":500,"y":220,"wires":[["d2d583fb.d57c1","c332982c.30c208"]]},{"id":"ea852383.5569c","type":"debug","z":"792fa8ec.b28a38","name":"","active":false,"console":"false","complete":"payload","x":430,"y":360,"wires":[]},{"id":"c332982c.30c208","type":"emoncms","z":"792fa8ec.b28a38","name":"Emoncms node 17","emonServer":"31ccddc3.399cc2","nodegroup":"17","datatype":"legacy","x":870,"y":220,"wires":[]},{"id":"f9e7836d.40c38","type":"emoncms","z":"792fa8ec.b28a38","name":"Emoncms node 5","emonServer":"31ccddc3.399cc2","nodegroup":"5","datatype":"legacy","x":870,"y":180,"wires":[]},{"id":"55e86cad.0ad274","type":"VerisureSensorNode","z":"a941cad7.5549a8","name":"Verisure Sensor","user":"e860117e.3ef7","x":440,"y":640,"wires":[["ab151a90.58cc08"]]},{"id":"ab151a90.58cc08","type":"debug","z":"a941cad7.5549a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":690,"y":640,"wires":[]},{"id":"f640ea46.788c18","type":"inject","z":"a941cad7.5549a8","name":"Lock","topic":"","payload":"{\"type\":\"lock\",\"label\":\"2AQS 4YQN\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":640,"wires":[["55e86cad.0ad274"]]},{"id":"8c04009d.b172f","type":"inject","z":"a941cad7.5549a8","name":"Verisure site","topic":"","payload":"{\"type\": \"site\"} ","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":600,"wires":[["55e86cad.0ad274"]]},{"id":"5c0c0418.c89e4c","type":"exec","z":"a941cad7.5549a8","command":"vsure henols@googlemail.com F331g00d@12 set smartplug '2A7B 43NZ' ","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Switch cmd","x":390,"y":840,"wires":[["c8a761fe.01563"],["afa85d21.e7755"],["32096bc4.fd7924"]]},{"id":"c8a761fe.01563","type":"debug","z":"a941cad7.5549a8","name":"Stdout","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":670,"y":800,"wires":[]},{"id":"a9f1f1a2.957d5","type":"inject","z":"a941cad7.5549a8","name":"Switch on","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":820,"wires":[["5c0c0418.c89e4c"]]},{"id":"c8b09b7e.b627b8","type":"inject","z":"a941cad7.5549a8","name":"Switch off","topic":"","payload":"off","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":860,"wires":[["5c0c0418.c89e4c"]]},{"id":"afa85d21.e7755","type":"debug","z":"a941cad7.5549a8","name":"Stderr","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":670,"y":840,"wires":[]},{"id":"32096bc4.fd7924","type":"debug","z":"a941cad7.5549a8","name":"Return code","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":690,"y":880,"wires":[]},{"id":"7e94d398.980a3c","type":"inject","z":"a941cad7.5549a8","name":"Smart plug","topic":"","payload":"{\"type\":\"smartPlug\",\"label\":\"2A7B 43NZ\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":680,"wires":[["55e86cad.0ad274"]]},{"id":"1735078.1477bf9","type":"mqtt out","z":"e2391743.cbd018","name":"","topic":"","qos":"","retain":"","broker":"fee7a4df.4347c8","x":670,"y":200,"wires":[]},{"id":"e51c7a77.569c58","type":"debug","z":"e2391743.cbd018","name":"","active":false,"console":"false","complete":"false","x":690,"y":160,"wires":[]},{"id":"853a3ebb.77ced","type":"function","z":"e2391743.cbd018","name":"","func":"var newMsg = {};\nif (msg.payload.cmd == 'report') {\n    var data = JSON.parse(msg.payload.data);\n    if (data.no_motion) {\n        newMsg.payload = \"no_motion\";\n    } else if (data.status ){\n        newMsg.payload = data.status;\n    } else {\n        newMsg.payload = msg.payload.data;\n    }\n    newMsg.topic = 'xiaomi/' + msg.payload.model + '/' + msg.payload.sid + '/status';\n    return [msg, newMsg];\n} \n\nreturn null;","outputs":"2","noerr":0,"x":520,"y":180,"wires":[["e51c7a77.569c58"],["1735078.1477bf9"]]},{"id":"d352d45a.aade98","type":"json","z":"e2391743.cbd018","name":"","property":"payload","action":"","pretty":false,"x":380,"y":180,"wires":[["853a3ebb.77ced","2f60a6a9.905e7a"]]},{"id":"15cd55b0.c4d01a","type":"udp in","z":"e2391743.cbd018","name":"","iface":"","port":"9898","ipv":"udp4","multicast":"true","group":"224.0.0.50","datatype":"utf8","x":170,"y":180,"wires":[["d352d45a.aade98"]]},{"id":"4babb83.780d548","type":"comment","z":"e2391743.cbd018","name":"Listen for Xiaomi sensors","info":"every msg type != cmd:report gets filtered out.","x":190,"y":120,"wires":[]},{"id":"f1543c5c.13a8f","type":"debug","z":"e2391743.cbd018","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1070,"y":200,"wires":[]},{"id":"ed3e56d4.920008","type":"xiaomi-human-body-sensor","z":"e2391743.cbd018","gateway":"75c355c6.2b40bc","name":"","sid":null,"motionmsg":"","nomotionmsg":"","output":"1","x":540,"y":380,"wires":[[]]},{"id":"1ae1e5bc.48c15a","type":"xiaomi-window-door-sensor","z":"e2391743.cbd018","gateway":"75c355c6.2b40bc","name":"","sid":null,"openmsg":"","closemsg":"","output":"1","x":500,"y":440,"wires":[[]]},{"id":"aa3c15b3.6cef28","type":"xiaomi-wall-switch","z":"e2391743.cbd018","gateway":"75c355c6.2b40bc","name":"","sid":null,"outmsg":"{{click}}","output":"1","x":460,"y":520,"wires":[[]]},{"id":"5400fbb9.a95f54","type":"mqtt in","z":"a941cad7.5549a8","name":"Any SmartPlug ","topic":"smartplug/+/output","qos":"1","broker":"fee7a4df.4347c8","x":120,"y":180,"wires":[["6655a16d.d102b"]]},{"id":"6655a16d.d102b","type":"switch","z":"a941cad7.5549a8","name":"Match SmartPlug","property":"topic","propertyType":"msg","rules":[{"t":"regex","v":"\\b\\/([\\dA-Z]{2,4} [\\dA-Z]{2,4})\\/*","vt":"str","case":false},{"t":"regex","v":"\\b\\/(\\d{2,8})\\/+","vt":"str","case":false}],"checkall":"false","repair":true,"outputs":2,"x":410,"y":180,"wires":[["52104295.a4c52c"],["dd7d2a03.897b28"]]},{"id":"5b406114.d5f0f","type":"inject","z":"a941cad7.5549a8","name":"Switch off","topic":"smartplug/2A7B 43NZ/output","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":"","x":800,"y":60,"wires":[["6e6dc55b.cd7e4c"]]},{"id":"6e6dc55b.cd7e4c","type":"mqtt out","z":"a941cad7.5549a8","name":"SmartPlug 9987695","topic":"","qos":"1","retain":"","broker":"fee7a4df.4347c8","x":1060,"y":60,"wires":[]},{"id":"e6862ca6.691cc","type":"inject","z":"a941cad7.5549a8","name":"Switch on","topic":"smartplug/2A7B 43NZ/output","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":"","x":800,"y":100,"wires":[["6e6dc55b.cd7e4c"]]},{"id":"dd7d2a03.897b28","type":"debug","z":"a941cad7.5549a8","name":"Match ESP smart plug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":980,"y":480,"wires":[]},{"id":"b45b4e29.ffdb1","type":"pushbullet","z":"792fa8ec.b28a38","config":"ab4639e2.fd1e08","pushtype":"note","title":"Temperature","chan":"","name":"Temperature","x":990,"y":380,"wires":[]},{"id":"df80a9a1.95a3b8","type":"pushbullet","z":"792fa8ec.b28a38","config":"ab4639e2.fd1e08","pushtype":"note","title":"Energy","chan":"","name":"Energy","x":980,"y":420,"wires":[]},{"id":"4b8b4b1d.11aa84","type":"inject","z":"a941cad7.5549a8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"","x":130,"y":80,"wires":[["5aa1ff39.aa77b"]]},{"id":"5aa1ff39.aa77b","type":"change","z":"a941cad7.5549a8","name":"Verisore config","rules":[{"t":"set","p":"vsure-user","pt":"global","to":"henols@googlemail.com","tot":"str"},{"t":"set","p":"vsure-password","pt":"global","to":"F331g00d@12","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":80,"wires":[["92e6d2fe.d027d"]]},{"id":"92e6d2fe.d027d","type":"debug","z":"a941cad7.5549a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":610,"y":80,"wires":[]},{"id":"bafc810b.84369","type":"template","z":"a941cad7.5549a8","name":"Vsure SmartPlug params","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{global.vsure-user}} {{global.vsure-password}} set smartplug '{{deviceId}}' {{state}} ","output":"str","x":150,"y":280,"wires":[["6a7f2ee6.999a5"]]},{"id":"6a7f2ee6.999a5","type":"exec","z":"a941cad7.5549a8","command":"vsure","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Vsure cmd","x":390,"y":280,"wires":[["2123c931.d44d86"],[],[]]},{"id":"52104295.a4c52c","type":"change","z":"a941cad7.5549a8","name":"Translate to Vsure state","rules":[{"t":"change","p":"payload","pt":"msg","from":"0","fromt":"num","to":"off","tot":"str"},{"t":"change","p":"payload","pt":"msg","from":"1","fromt":"num","to":"on","tot":"str"},{"t":"set","p":"deviceId","pt":"msg","to":"$split(msg.topic, '/', 2)[1]\t","tot":"jsonata"},{"t":"change","p":"payload","pt":"msg","from":"0","fromt":"str","to":"off","tot":"str"},{"t":"change","p":"payload","pt":"msg","from":"1","fromt":"str","to":"on","tot":"str"},{"t":"move","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":690,"y":180,"wires":[["bafc810b.84369","920f6dd5.6d276"]]},{"id":"2123c931.d44d86","type":"switch","z":"a941cad7.5549a8","name":"Test return code","property":"rc.code","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":660,"y":280,"wires":[["de0ccea8.f7421","aec062f7.3bbcc"]]},{"id":"de0ccea8.f7421","type":"template","z":"a941cad7.5549a8","name":"SmartPlug state request","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"type\":\"smartPlug\",\"label\":\"{{deviceId}}\"}","output":"json","x":150,"y":380,"wires":[["23b67aa0.eee9f6"]]},{"id":"23b67aa0.eee9f6","type":"VerisureSensorNode","z":"a941cad7.5549a8","name":"Verisure Sensor","user":"e860117e.3ef7","x":400,"y":380,"wires":[["63869d66.3ba674"]]},{"id":"63869d66.3ba674","type":"change","z":"a941cad7.5549a8","name":"Translate SmartPlug state","rules":[{"t":"change","p":"payload.currentState","pt":"msg","from":"OFF","fromt":"str","to":"0","tot":"str"},{"t":"change","p":"payload.currentState","pt":"msg","from":"ON","fromt":"str","to":"1","tot":"str"},{"t":"move","p":"payload.currentState","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":690,"y":380,"wires":[["dfc88add.6e1fb8","c92b14c7.75ef38"]]},{"id":"dfc88add.6e1fb8","type":"template","z":"a941cad7.5549a8","name":"SmartPlug topic","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"smartplug/{{deviceId}}/state","output":"str","x":400,"y":480,"wires":[["be251df2.cc42a"]]},{"id":"be251df2.cc42a","type":"mqtt out","z":"a941cad7.5549a8","name":"SmartPlug state","topic":"","qos":"1","retain":"true","broker":"fee7a4df.4347c8","x":660,"y":480,"wires":[]},{"id":"920f6dd5.6d276","type":"debug","z":"a941cad7.5549a8","name":"SmartPlug request","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":970,"y":180,"wires":[]},{"id":"c92b14c7.75ef38","type":"debug","z":"a941cad7.5549a8","name":"SmartPlug state","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":960,"y":380,"wires":[]},{"id":"aec062f7.3bbcc","type":"debug","z":"a941cad7.5549a8","name":"SmartPlug cmd response","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":990,"y":280,"wires":[]},{"id":"679e114d.c65e5","type":"debug","z":"2e500814.3e3ca8","name":"","active":true,"console":"false","complete":"payload","x":1070,"y":420,"wires":[]},{"id":"61bc26c6.818118","type":"inject","z":"2e500814.3e3ca8","name":"Generate Token","topic":"authorize","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":71,"y":427,"wires":[["c772ac84.8c983"]]},{"id":"568bb0a1.fc7c9","type":"http request","z":"2e500814.3e3ca8","name":"OAuth Server","method":"POST","ret":"obj","url":"https://mysite.com/oauth2/access_token","x":852,"y":323,"wires":[["679e114d.c65e5"]]},{"id":"c772ac84.8c983","type":"function","z":"2e500814.3e3ca8","name":"Credentials","func":"msg.credentials = {\n    product_id: \"myid\",\n    product_secret: \"mysecret\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":252,"y":427,"wires":[["76f1b0c5.29aa2"]]},{"id":"76f1b0c5.29aa2","type":"function","z":"2e500814.3e3ca8","name":"Headers","func":"msg.headers = {\n    \"Content-Type\": \"application/x-www-form-urlencoded\",\n    \"Accepts\": \"application/json\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":453,"y":323,"wires":[["d3d35bc9.f5d8e8"]]},{"id":"20d29d23.82e0d2","type":"comment","z":"2e500814.3e3ca8","name":"Enter credentials here","info":"Enter an authorization key, your client/product id and secret here.","x":249,"y":378,"wires":[]},{"id":"26667ee1.6489b2","type":"comment","z":"2e500814.3e3ca8","name":"Enter server details here","info":"","x":850,"y":364,"wires":[]},{"id":"d3d35bc9.f5d8e8","type":"template","z":"2e500814.3e3ca8","name":"Auth Form Encode","field":"payload","format":"handlebars","template":"client_id={{credentials.product_id}}&client_secret={{credentials.product_secret}}&grant_type=client_credentials","x":652,"y":323,"wires":[["568bb0a1.fc7c9"]]},{"id":"2f60a6a9.905e7a","type":"xiaomi-switch","z":"e2391743.cbd018","gateway":"93b41423.ea0f18","name":"","sid":null,"outmsg":"{{click}}","outmsgdbcl":"{{double_click}}","output":"0","x":620,"y":260,"wires":[["f1543c5c.13a8f"],["f1543c5c.13a8f"]]}]